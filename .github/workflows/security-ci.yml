name: Security & CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-and-scan:
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: advanced-calculator:latest
      TARGET_URL: 'http://localhost:5000'  # Change if your app is hosted somewhere else
    steps:

    # 1. Checkout code
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 3. Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest coverage safety

    # 4. Run tests
    - name: Run tests with coverage
      run: |
        coverage run -m unittest discover -s tests
        coverage report

    # 5. Python vulnerability scan
    - name: Safety vulnerability scan
      run: |
        pip freeze > requirements.txt
        safety check --file=requirements.txt --full-report

    # 6. Build Docker image
    - name: Build Docker image
      run: |
        docker build -t $DOCKER_IMAGE .

    # 7. Docker vulnerability scan
    - name: Scan Docker image
      run: |
        docker pull aquasec/trivy:latest
        docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image $DOCKER_IMAGE

    # 8. OWASP ZAP scan
    - name: Run OWASP ZAP scan
      uses: zaproxy/action-full-scan@v0.9.0
      with:
        target: ${{ env.TARGET_URL }}
        rules_file_name: ''  # Leave empty unless you have custom rules
        fail_on_alert: 'true'
        format: 'html'
        report_file: 'zap_report.html'

    # 9. Upload ZAP report
    - name: Upload ZAP report
      uses: actions/upload-artifact@v3
      with:
        name: zap-report
        path: zap_report.html
